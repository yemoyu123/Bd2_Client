name: Release Notification

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Message
        run: |
          # 1. 处理标题
          TITLE="${{ github.event.release.name }}"
          if [ -z "$TITLE" ]; then TITLE="${{ github.event.release.tag_name }}"; fi

          # 2. 处理正文描述 (Body)
          # 使用 jq 处理特殊的换行符和转义字符，并限制长度在 500 字以内防止爆框
          RAW_BODY=$(cat << 'EOF'
          ${{ github.event.release.body }}
          EOF
          )
          
          # 截取前 500 个字符并在末尾添加省略号
          CLEAN_BODY=$(echo "$RAW_BODY" | head -c 500)
          if [ ${#RAW_BODY} -gt 500 ]; then CLEAN_BODY="${CLEAN_BODY}..."; fi

          # 3. 发送请求
          curl -H "Content-Type: application/json" \
          -X POST \
          -d @- << EOF
          {
            "username": "Chisato Release Bot",
            "avatar_url": "https://raw.githubusercontent.com/LycoRecoCoffee/LycoRecoCoffee/main/332dd72418f86c0f1c1cff9481ac0b66be3294a8.jpg",
            "embeds": [{
              "title": "$TITLE",
              "description": "### 更新日志\n> $CLEAN_BODY\n\n[ 查看完整更新并下载附件](${{ github.event.release.html_url }})",
              "url": "${{ github.event.release.html_url }}",
              "color": 65280,
              "fields": [
                {
                  "name": "版本",
                  "value": "\`${{ github.event.release.tag_name }}\`",
                  "inline": true
                },
                {
                  "name": "分支",
                  "value": "\`${{ github.event.release.target_commitish }}\`",
                  "inline": true
                }
              ],
              "footer": {
                "text": "项目: ${{ github.repository }} | 时间: $(date '+%Y-%m-%d %H:%M')"
              }
            }]
          }
          EOF
